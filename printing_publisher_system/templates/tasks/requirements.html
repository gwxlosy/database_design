<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>任务材料需求 - 印刷出版商管理系统</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<header class="navbar">
  <div class="navbar-brand">印刷出版商数据库管理系统</div>
  <nav class="navbar-links">
    <a href="{{ url_for('index') }}">首页</a>
    <a href="{{ url_for('list_tasks') }}">印刷任务</a>
    <a href="{{ url_for('inventory_overview') }}">库存管理</a>
  </nav>
</header>

<main class="container">
  <div class="page-header">
    <h1>任务材料需求</h1>
    <a href="{{ url_for('list_tasks') }}" class="btn">返回任务列表</a>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="messages">
        {% for category, message in messages %}
          <div class="alert {{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% if task %}
    <section class="card">
      <h2>任务信息</h2>
      <p><strong>任务ID：</strong>{{ task['印刷任务id'] }}</p>
      <p><strong>员工ID：</strong>{{ task['员工id'] }}</p>
      <p><strong>书籍ID：</strong>{{ task['书籍id'] }}</p>
      <p><strong>印刷数量：</strong>{{ task['印刷数量'] }}</p>
      <p><strong>预计完成日期：</strong>{{ task['预计完成日期'] }}</p>
      <p><strong>当前状态：</strong>{{ task['任务状态'] }}</p>
    </section>

    <section class="card">
      <h2>材料需求与库存对比</h2>
      {% if items and items|length > 0 %}
        <table class="table">
          <thead>
            <tr>
              <th>材料ID</th>
              <th>材料名称</th>
              <th>需求数量</th>
              <th>当前库存</th>
              <th>短缺数量</th>
            </tr>
          </thead>
          <tbody>
          {% set has_shortage = false %}
          {% for it in items %}
            {% if it.shortage and it.shortage > 0 %}{% set has_shortage = true %}{% endif %}
            <tr>
              <td>{{ it.material_id }}</td>
              <td>{{ it.material_name }}</td>
              <td>{{ it.required_qty }}</td>
              <td>{{ it.current_stock }}</td>
              <td>{% if it.shortage and it.shortage > 0 %}<span style="color:#e74c3c;">{{ it.shortage }}</span>{% else %}0{% endif %}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>

        {% if task['任务状态'] != '已完成' and task['任务状态'] != '已取消' %}
          <div class="card" style="margin-top:12px;">
            <h3>完成任务</h3>
            {% if has_shortage %}
              <div class="alert warning">库存不足，无法完成任务。请先补足短缺材料再尝试完成。</div>
            {% else %}
              <form method="post" action="{{ url_for('task_complete_manual', task_id=task['印刷任务id']) }}" class="form" style="max-width:600px;">
                {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
                <div class="form-group">
                  <label>完成日期：</label>
                  <input type="date" name="completed_date" value="{{ default_completed_date }}" />
                </div>
                <div class="form-group">
                  <label>操作员工ID（可选）：</label>
                  <input type="number" name="operator_employee_id" placeholder="不填则使用当前用户名映射的员工ID">
                </div>
                <button class="btn primary" type="submit">确认完成并扣减库存</button>
              </form>
            {% endif %}
          </div>
        {% endif %}
      {% else %}
        <p>无材料需求。</p>
      {% endif %}
    </section>
  {% else %}
    <p>任务不存在。</p>
  {% endif %}
</main>
</body>
</html>

