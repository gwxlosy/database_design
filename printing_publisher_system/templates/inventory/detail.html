<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>材料详情 - 库存管理</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<header class="navbar">
    <div class="navbar-brand">印刷出版商数据库管理系统</div>
    <nav class="navbar-links">
        <a href="{{ url_for('index') }}">首页</a>
        <a href="{{ url_for('inventory_overview') }}">库存总览</a>
        <a href="{{ url_for('inventory_materials') }}">材料列表</a>
        <a href="{{ url_for('inventory_logs') }}">库存日志</a>
    </nav>
</header>

<main class="container">
    <h1>材料详情</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="messages">
          {% for category, message in messages %}
            <div class="alert {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if material %}
      <section class="card">
        <h2>基础信息</h2>
        <p><strong>材料ID：</strong>{{ material['材料id'] }}</p>
        <p><strong>材料名称：</strong>{{ material['材料名称'] }}</p>
        <p><strong>规格：</strong>{{ material.get('规格') or '-' }}</p>
        <p><strong>计量单位：</strong>{{ material.get('计量单位') or '-' }}</p>
        <p><strong>库存数量：</strong>{{ material['库存数量'] }}</p>
        <p><strong>安全库存：</strong>{{ material.get('安全库存') or 0 }}</p>
        <p><strong>标准单价：</strong>{{ material.get('标准单价') or '-' }}</p>
      </section>

      <section class="card">
        <h2>库存操作</h2>
        {% if is_inventory_operator %}
          <div class="grid" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px;">
            <form method="post" action="{{ url_for('inventory_stock_in', material_id=material['材料id']) }}" class="form">
              {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
              <h3>入库</h3>
              <input type="number" step="0.001" min="0.001" name="quantity" placeholder="数量" required>
              <input type="text" name="note" placeholder="备注（可选）">
              <button class="btn primary" type="submit">入库</button>
            </form>

            <form method="post" action="{{ url_for('inventory_stock_out', material_id=material['材料id']) }}" class="form">
              {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
              <h3>出库</h3>
              <input type="number" step="0.001" min="0.001" name="quantity" placeholder="数量" required>
              <input type="text" name="note" placeholder="备注（可选）">
              <button class="btn" type="submit">出库</button>
            </form>

            <form method="post" action="{{ url_for('inventory_stock_adjust', material_id=material['材料id']) }}" class="form">
              {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
              <h3>调整</h3>
              <input type="number" step="0.001" name="delta" placeholder="调整值（可正可负）" required>
              <input type="text" name="note" placeholder="备注（可选）">
              <button class="btn" type="submit">调整</button>
            </form>
          </div>
        {% else %}
          <div class="alert warning">当前账号无库存操作权限（需要 管理员/采购/仓储）。</div>
        {% endif %}
      </section>

      <section class="card">
        <h2>参数设置</h2>
        {% if is_inventory_operator %}
          <form method="post" action="{{ url_for('inventory_material_settings', material_id=material['材料id']) }}" class="form" style="max-width:560px;">
            {% if csrf_token %}<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">{% endif %}
            <div class="form-group">
              <label>安全库存：</label>
              <input type="number" step="0.001" name="safety_stock" placeholder="不改可留空">
            </div>
            <div class="form-group">
              <label>标准单价：</label>
              <input type="number" step="0.01" name="unit_price" placeholder="不改可留空">
            </div>
            <button class="btn" type="submit">保存</button>
          </form>
        {% else %}
          <div class="alert warning">当前账号无库存参数维护权限（需要 管理员/采购/仓储）。</div>
        {% endif %}
      </section>

      <section class="card">
        <h2>变动日志（最近）</h2>
        {% if logs and logs|length > 0 %}
          <table class="table">
            <thead>
              <tr>
                <th>时间</th>
                <th>变动数量</th>
                <th>类型</th>
                <th>关联</th>
                <th>操作人</th>
                <th>备注</th>
              </tr>
            </thead>
            <tbody>
              {% for log in logs %}
                <tr>
                  <td>{{ log.get('变动时间') }}</td>
                  <td>{{ log.get('库存变动数量') }}</td>
                  <td>{{ log.get('变动类型') }}</td>
                  <td>{{ log.get('关联的业务记录标识') }}</td>
                  <td>{{ log.get('操作人姓名') or log.get('操作人') }}</td>
                  <td>{{ log.get('备注') or '-' }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p>暂无日志记录。</p>
        {% endif %}
      </section>

    {% else %}
      <p>材料不存在或已被删除。</p>
    {% endif %}
</main>
</body>
</html>

