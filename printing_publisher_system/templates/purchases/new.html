<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>新建采购 - 印刷出版商管理系统</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<header class="navbar">
    <div class="navbar-brand">印刷出版商数据库管理系统</div>
    <nav class="navbar-links">
        <a href="{{ url_for('index') }}">首页</a>
        <a href="{{ url_for('purchases_list') }}">采购管理</a>
    </nav>
</header>

<main class="container">
    <h1>新建采购记录</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="messages">
          {% for category, message in messages %}
            <div class="alert {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <form method="post" class="form" style="max-width: 640px;">
        {% if csrf_token %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% endif %}
        <div class="form-group">
            <label for="task_id">印刷任务：</label>
            <select id="task_id" name="task_id" required>
                <option value="">请选择印刷任务</option>
                {% for t in tasks %}
                <option value="{{ t['印刷任务id'] }}">{{ t['印刷任务id'] }} - {{ t.get('书籍id') }} - {{ t.get('任务状态') }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="link_id">材料-供应商：</label>
            <select id="link_id" name="link_id" required>
                <option value="">请选择...</option>
                {% for lk in links %}
                    <option value="{{ lk['材料供应商关联id'] }}">
                        {{ lk.get('材料名称') or '材料#' ~ lk.get('材料id') }} - {{ lk.get('供应商名称') or '供应商#' ~ lk.get('供应商id') }} - 单价：{{ lk.get('供应商提供的材料单价') }} {% if lk.get('是否为首选供应商') == '是' %}（首选）{% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="quantity">采购数量：</label>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
                <input type="number" id="quantity" name="quantity" required min="0.001" step="0.001" placeholder="例如：100.000" style="flex:1; min-width:160px;">
                <span id="required_hint" style="color:#888; font-size:0.9em;">需求量：--</span>
            </div>
        </div>
        <div class="form-actions">
            <button type="submit" class="btn primary">创建采购</button>
            <a href="{{ url_for('purchases_list') }}" class="btn">返回列表</a>
        </div>
    </form>

    {% if not links or links|length == 0 %}
    <div class="alert warning" style="margin-top: 16px;">
        尚未创建任何材料-供应商关联，请先到“材料/供应商”中新增关联后再创建采购。
    </div>
    {% endif %}
</main>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const taskInput = document.getElementById('task_id');
  const linkSelect = document.getElementById('link_id');
  const hint = document.getElementById('required_hint');

  async function updateHint() {
    const taskId = parseInt(taskInput.value || '0', 10);
    const linkId = parseInt(linkSelect.value || '0', 10);
    if (!taskId || !linkId) {
      hint.textContent = '需求量：--';
      return;
    }
    try {
      const resp = await fetch(`{{ url_for('api_requirement') }}?task_id=${taskId}&link_id=${linkId}`);
      const data = await resp.json();
      if (data.success) {
        hint.textContent = `需求量：${data.required_qty}`;
      } else {
        hint.textContent = '需求量：获取失败';
      }
    } catch (e) {
      hint.textContent = '需求量：获取失败';
    }
  }

  taskInput.addEventListener('change', updateHint);
  linkSelect.addEventListener('change', updateHint);
});
</script>
</body>
</html>

