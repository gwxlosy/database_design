# MySQL远程连接配置指南

## 问题描述
远程客户端连接MySQL服务器时出现错误：
```
2003 (HY000): Can't connect to MySQL server on '10.82.157.204:3306' (10060)
```

错误10060表示连接超时，通常是因为服务器端未正确配置允许远程连接。

## 解决方案（在数据库服务器端执行）

### 步骤1: 配置MySQL允许远程连接

#### 1.1 找到MySQL配置文件
- **Windows**: `C:\ProgramData\MySQL\MySQL Server X.X\my.ini`
- 或: `C:\Program Files\MySQL\MySQL Server X.X\my.ini`

#### 1.2 修改配置文件
打开 `my.ini` 文件，找到 `[mysqld]` 部分，修改或添加：

```ini
[mysqld]
bind-address = 0.0.0.0    # 允许所有IP连接（推荐用于测试）
# 或
bind-address = 10.82.157.204  # 只绑定到服务器IP（更安全）
```

**注意**：
- 如果 `bind-address` 被设置为 `127.0.0.1` 或 `localhost`，MySQL只接受本地连接
- 设置为 `0.0.0.0` 允许所有IP连接
- 设置为服务器IP只允许从该IP连接

#### 1.3 重启MySQL服务
1. 按 `Win + R`，输入 `services.msc`
2. 找到 `MySQL` 服务
3. 右键 -> 重新启动

或使用命令行（管理员权限）：
```cmd
net stop MySQL
net start MySQL
```

### 步骤2: 配置Windows防火墙

#### 方法1: 使用命令行（推荐）
以管理员身份运行PowerShell或CMD，执行：
```cmd
netsh advfirewall firewall add rule name="MySQL" dir=in action=allow protocol=TCP localport=3306
```

#### 方法2: 使用图形界面
1. 打开"Windows Defender 防火墙"
2. 点击"高级设置"
3. 点击"入站规则" -> "新建规则"
4. 选择"端口" -> "TCP" -> "特定本地端口" -> 输入 `3306`
5. 选择"允许连接"
6. 应用到所有配置文件（域、专用、公用）
7. 命名规则为"MySQL"

### 步骤3: 配置MySQL用户权限

#### 3.1 连接到MySQL
在服务器端，使用命令行或MySQL Workbench连接到MySQL：
```cmd
mysql -u root -p
```

#### 3.2 授予远程访问权限

**方法A: 允许所有IP访问（简单但不安全）**
```sql
-- 创建允许所有IP访问的用户（如果不存在）
CREATE USER IF NOT EXISTS 'root'@'%' IDENTIFIED BY '你的密码';

-- 授予权限
GRANT ALL PRIVILEGES ON printing_publisher_db.* TO 'root'@'%';

-- 刷新权限
FLUSH PRIVILEGES;
```

**方法B: 只允许特定IP访问（推荐，更安全）**
```sql
-- 假设客户端IP是 192.168.1.100
CREATE USER IF NOT EXISTS 'root'@'192.168.1.100' IDENTIFIED BY '你的密码';
GRANT ALL PRIVILEGES ON printing_publisher_db.* TO 'root'@'192.168.1.100';
FLUSH PRIVILEGES;
```

**方法C: 允许IP段访问**
```sql
-- 允许 192.168.1.x 网段访问
CREATE USER IF NOT EXISTS 'root'@'192.168.1.%' IDENTIFIED BY '你的密码';
GRANT ALL PRIVILEGES ON printing_publisher_db.* TO 'root'@'192.168.1.%';
FLUSH PRIVILEGES;
```

#### 3.3 检查用户权限
```sql
SELECT user, host FROM mysql.user WHERE user = 'root';
```

应该看到类似：
```
+------+----------------+
| user | host           |
+------+----------------+
| root | localhost      |
| root | %              |  <-- 这个允许远程访问
+------+----------------+
```

### 步骤4: 验证配置

#### 4.1 在服务器端测试
使用Python脚本测试：
```python
import mysql.connector

config = {
    'host': '10.82.157.204',  # 使用服务器IP
    'port': 3306,
    'user': 'root',
    'password': '你的密码',
    'database': 'printing_publisher_db'
}

try:
    conn = mysql.connector.connect(**config)
    print("✅ 远程连接成功！")
    conn.close()
except Exception as e:
    print(f"❌ 连接失败: {e}")
```

#### 4.2 在远程客户端测试
确保远程客户端的配置文件 `settings.py` 中host设置为服务器IP：
```python
DB_CONFIG = {
    'host': '10.82.157.204',  # 服务器IP
    'port': 3306,
    'user': 'root',
    'password': '你的密码',
    'database': 'printing_publisher_db',
    'charset': 'utf8mb4',
    'connect_timeout': 10
}
```

然后运行测试：
```cmd
python tests/test_database.py
```

## 使用自动配置脚本

在服务器端运行：
```cmd
python tests/fix_remote_connection.py
```

这个脚本会：
1. 检查并提示配置bind-address
2. 检查并提示配置防火墙
3. 自动授予MySQL用户远程访问权限
4. 测试连接配置

## 常见问题排查

### 问题1: 仍然无法连接
1. **检查MySQL服务是否运行**
   ```cmd
   net start MySQL
   ```

2. **检查端口是否被占用**
   ```cmd
   netstat -an | findstr 3306
   ```
   应该看到 `0.0.0.0:3306` 或 `10.82.157.204:3306`

3. **检查防火墙规则**
   ```cmd
   netsh advfirewall firewall show rule name="MySQL"
   ```

4. **检查MySQL错误日志**
   - Windows: `C:\ProgramData\MySQL\MySQL Server X.X\Data\*.err`

### 问题2: 连接被拒绝（不是超时）
- 检查用户权限是否正确配置
- 检查密码是否正确
- 检查数据库名称是否正确

### 问题3: 只能从某些IP连接
- 检查防火墙是否只允许特定IP
- 检查MySQL用户权限中的host设置

## 安全建议

1. **使用强密码**
2. **限制访问IP**：只允许必要的IP访问，不要使用 `%`
3. **创建专用用户**：不要使用root用户进行远程连接，创建专用用户
   ```sql
   CREATE USER 'app_user'@'客户端IP' IDENTIFIED BY '强密码';
   GRANT SELECT, INSERT, UPDATE, DELETE ON printing_publisher_db.* TO 'app_user'@'客户端IP';
   FLUSH PRIVILEGES;
   ```
4. **使用SSL连接**（可选，提高安全性）
5. **定期更新MySQL版本**

## 快速检查清单

- [ ] MySQL配置文件 `my.ini` 中 `bind-address = 0.0.0.0`
- [ ] MySQL服务已重启
- [ ] Windows防火墙已允许3306端口
- [ ] MySQL用户已授予远程访问权限（`'root'@'%'` 或特定IP）
- [ ] 已执行 `FLUSH PRIVILEGES`
- [ ] 远程客户端配置文件host设置为服务器IP
- [ ] 网络连接正常（可以ping通服务器IP）

完成以上所有步骤后，远程连接应该可以正常工作了！


