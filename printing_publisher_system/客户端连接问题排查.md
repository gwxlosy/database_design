# 客户端连接问题排查指南

## 当前错误
```
2003 (HY000): Can't connect to MySQL server on '10.82.157.204:3306' (10060)
```

## 快速诊断步骤

### 在客户端运行诊断脚本
```cmd
python tests/diagnose_connection.py
```

这个脚本会自动检查：
1. ✅ 网络连通性（能否ping通服务器）
2. ✅ 端口连通性（3306端口是否可达）
3. ✅ 客户端配置是否正确
4. ✅ MySQL连接测试

## 常见问题及解决方案

### 问题1: 配置文件host设置错误

**检查**: `src/config/settings.py` 中的 `host` 设置

**当前应该设置为**:
```python
DB_CONFIG = {
    'host': '10.82.157.204',  # 服务器IP地址
    'port': 3306,
    # ... 其他配置
}
```

**如果设置为 `'localhost'`，只会连接本地数据库，无法连接远程服务器**

### 问题2: 服务器端未配置允许远程连接

**需要在服务器端执行以下操作**:

#### 2.1 修改MySQL配置文件
1. 找到 `my.ini` 文件（通常在 `C:\ProgramData\MySQL\MySQL Server X.X\`）
2. 找到 `[mysqld]` 部分
3. 修改或添加：
   ```ini
   [mysqld]
   bind-address = 0.0.0.0
   ```
4. 保存文件
5. **重启MySQL服务**（重要！）

#### 2.2 配置Windows防火墙
以管理员身份运行PowerShell或CMD：
```cmd
netsh advfirewall firewall add rule name="MySQL" dir=in action=allow protocol=TCP localport=3306
```

#### 2.3 授予MySQL用户远程访问权限
连接到MySQL后执行：
```sql
-- 允许所有IP访问（测试用）
GRANT ALL PRIVILEGES ON printing_publisher_db.* TO 'root'@'%' IDENTIFIED BY '18302057923ljl';
FLUSH PRIVILEGES;

-- 或者只允许特定IP访问（更安全）
-- GRANT ALL PRIVILEGES ON printing_publisher_db.* TO 'root'@'客户端IP' IDENTIFIED BY '18302057923ljl';
-- FLUSH PRIVILEGES;
```

### 问题3: 网络不通

**测试方法**:
```cmd
ping 10.82.157.204
```

如果ping不通，检查：
- 服务器是否开机
- 网络连接是否正常
- IP地址是否正确
- 是否在同一网络

### 问题4: 端口被阻止

**测试方法**:
```cmd
telnet 10.82.157.204 3306
```

如果连接失败，可能是：
- 服务器防火墙阻止了3306端口
- 路由器/网络防火墙阻止了连接
- MySQL服务未运行

## 完整检查清单

### 服务器端检查清单
- [ ] MySQL配置文件 `my.ini` 中 `bind-address = 0.0.0.0`
- [ ] MySQL服务已重启（修改配置后必须重启）
- [ ] Windows防火墙已允许3306端口
- [ ] MySQL用户已授予远程访问权限（`'root'@'%'`）
- [ ] 已执行 `FLUSH PRIVILEGES`
- [ ] MySQL服务正在运行

### 客户端检查清单
- [ ] 配置文件 `host` 设置为服务器IP `10.82.157.204`
- [ ] 可以ping通服务器
- [ ] 可以连接到3306端口（使用telnet或诊断脚本）
- [ ] 用户名和密码正确
- [ ] 数据库名称正确

## 使用自动配置脚本

### 在服务器端运行
```cmd
python tests/fix_remote_connection.py
```

这个脚本会：
- 检查并提示配置bind-address
- 检查并提示配置防火墙
- 自动授予MySQL用户远程访问权限
- 测试连接配置

### 在客户端运行
```cmd
python tests/diagnose_connection.py
```

这个脚本会：
- 测试网络连通性
- 测试端口连通性
- 检查客户端配置
- 测试MySQL连接
- 提供详细的错误诊断

## 手动测试步骤

### 步骤1: 测试网络连通性
```cmd
ping 10.82.157.204
```
应该能看到回复，如果超时说明网络不通。

### 步骤2: 测试端口连通性
```cmd
telnet 10.82.157.204 3306
```
如果连接成功，会看到空白屏幕或MySQL欢迎信息。
如果连接失败，会显示"无法打开到主机的连接"。

### 步骤3: 测试MySQL连接
```cmd
python tests/test_database.py
```

## 如果仍然无法连接

1. **确认服务器端配置已完成**
   - 运行服务器端的 `fix_remote_connection.py`
   - 确认所有步骤都已完成

2. **检查网络环境**
   - 确认客户端和服务器在同一网络
   - 或者服务器有公网IP且端口已映射

3. **查看MySQL错误日志**
   - 服务器端: `C:\ProgramData\MySQL\MySQL Server X.X\Data\*.err`
   - 查看是否有连接尝试的记录

4. **尝试使用MySQL客户端工具**
   ```cmd
   mysql -h 10.82.157.204 -u root -p
   ```
   如果MySQL命令行工具也无法连接，说明是服务器端配置问题。

5. **检查是否有其他防火墙**
   - 公司/学校网络防火墙
   - 路由器防火墙
   - 第三方安全软件

## 联系支持

如果完成以上所有步骤后仍然无法连接，请提供：
1. 诊断脚本的完整输出
2. ping测试结果
3. telnet测试结果
4. 服务器端MySQL错误日志（如果有）


