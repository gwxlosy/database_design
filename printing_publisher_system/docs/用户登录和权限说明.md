# 用户登录和权限管理系统说明

## 概述

系统已添加用户登录功能和基于职位的权限控制。只有管理员可以修改员工表信息，其他职位用户只能查看。

## 功能特性

1. **用户登录系统**
   - 用户需要登录才能访问系统
   - 密码使用SHA256哈希存储
   - Session管理用户登录状态

2. **权限控制**
   - 所有页面需要登录才能访问
   - 只有"管理员"职位可以：
     - 创建新员工
     - 编辑员工信息
     - 删除员工
     - 为员工设置/重置登录账号和初始密码
   - 其他职位用户只能查看员工列表与修改自己的密码

3. **用户职位**
   - 编辑
   - 排版
   - 印刷工
   - 采购
   - 仓储
   - 销售
   - 人事
   - 管理员（拥有所有权限）

## 数据库设置

### 1. 创建用户表

**推荐方式：使用Python脚本（自动处理编码问题）**

```bash
python scripts/create_user_table_python.py
```

**方式2：直接执行SQL脚本**

```bash
mysql -u root -p printing_publisher_db < scripts/create_user_table.sql
```

如果遇到编码问题（如 `Unknown column` 错误），请使用Python脚本方式。

**方式3：手动执行SQL**

```sql
CREATE TABLE IF NOT EXISTS 用户表 (
    用户id INT AUTO_INCREMENT PRIMARY KEY COMMENT '用户ID，主键',
    用户名 VARCHAR(50) NOT NULL UNIQUE COMMENT '登录用户名，唯一',
    密码 VARCHAR(255) NOT NULL COMMENT '密码（SHA256哈希值）',
    职位 VARCHAR(20) NOT NULL COMMENT '用户职位',
    创建时间 DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '账户创建时间',
    INDEX idx_username (用户名),
    INDEX idx_position (职位)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='系统用户表';
```

### 2. 默认管理员账户

系统会自动创建默认管理员账户：
- **用户名**: `admin`
- **密码**: `admin123`
- **职位**: `管理员`

**重要**: 首次登录后请立即修改密码！

## 创建新用户

### 方法1：使用Python脚本（推荐）

```bash
python scripts/create_user_helper.py
```

按提示输入用户名、密码和职位即可。

### 方法2：直接插入数据库

计算密码的SHA256哈希值，然后执行SQL：

```python
import hashlib
password = "your_password"
hashed = hashlib.sha256(password.encode('utf-8')).hexdigest()
print(hashed)
```

然后执行：

```sql
INSERT INTO 用户表 (用户名, 密码, 职位) 
VALUES ('用户名', '密码的SHA256哈希值', '职位');
```

### 方法3：使用UserService（编程方式）

```python
from src.business_logic.user_service import UserService

user_service = UserService()
result = user_service.create_user('username', 'password', '职位')
```

### 管理员为员工设置初始账号

1. 打开“人员管理”列表，点击某员工行的“账号”按钮
2. 填写用户名与初始密码并保存
   - 若用户名不存在：创建新账号
   - 若用户名已存在：重置密码并更新职位为该员工职位

### 员工修改自己的密码

1. 登录后，导航栏点击“修改密码”
2. 输入旧密码、新密码（至少6位）提交
3. 修改成功后会自动登出，请用新密码重新登录

## 使用说明

### 登录

1. 访问系统首页，会自动重定向到登录页面
2. 输入用户名和密码
3. 登录成功后进入系统首页

### 登出

点击导航栏右上角的"登出"按钮即可退出登录。

### 权限说明

- **管理员**: 可以访问所有功能，包括员工表的增删改查
- **其他职位**: 可以查看员工列表，但无法创建、编辑或删除员工，仅可修改自己的密码

### 书籍与版本管理
- 登录后可查看书籍列表及版本
- 只有管理员可新增书籍、为书籍新增版本（版本新增接口已加管理员校验）
- 版本信息包含：版本描述、ISBN（必填）、开本、页数、版本创建日期

## 安全建议

1. **密码安全**
   - 生产环境建议使用bcrypt等更强的密码哈希算法
   - 当前使用SHA256，适合开发环境

2. **Session安全**
   - 确保`APP_SECRET_KEY`在生产环境中使用强随机密钥
   - 可以通过环境变量设置：`APP_SECRET_KEY=your-secret-key`

3. **HTTPS**
   - 生产环境务必使用HTTPS传输
   - 保护密码和Session Cookie的安全

## 文件结构

```
src/
├── business_logic/
│   └── user_service.py          # 用户服务（登录验证、用户管理）
├── database/
│   ├── models.py               # 用户模型定义
│   └── daos.py                 # 用户DAO（数据访问）
├── utils/
│   └── auth.py                 # 权限装饰器和工具函数
└── web_app.py                  # Flask应用（登录路由、权限检查）

templates/
└── login.html                  # 登录页面模板

scripts/
├── create_user_table.sql       # 创建用户表的SQL脚本
└── create_user_helper.py      # 创建用户的辅助脚本
```

## 故障排查

### 问题1：无法登录

1. 检查用户表是否存在
2. 检查用户名和密码是否正确
3. 查看应用日志了解详细错误信息

### 问题2：权限不足

1. 确认当前用户的职位是否为"管理员"
2. 检查Session中是否正确保存了用户信息
3. 尝试重新登录

### 问题3：用户表不存在

执行创建用户表的SQL脚本：
```bash
mysql -u root -p printing_publisher_db < scripts/create_user_table.sql
```

## 开发说明

### 添加新的权限检查

在路由上使用装饰器：

```python
from src.utils.auth import login_required, admin_required

@app.route("/some-route")
@login_required  # 需要登录
def some_route():
    pass

@app.route("/admin-route")
@login_required  # 需要登录
@admin_required  # 需要管理员权限
def admin_route():
    pass
```

### 在模板中使用用户信息

用户信息已自动注入到所有模板：

```jinja2
{% if current_user %}
    当前用户: {{ current_user.username }} ({{ current_user.position }})
{% endif %}

{% if is_admin %}
    <!-- 只有管理员可见的内容 -->
{% endif %}
```

